<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="theme-color" content="#09090b">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Control Loop Tuner</title>
<link rel="manifest" href="manifest.json">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--bg0:#09090b;--bg1:#18181b;--bg2:#27272a;--bg3:#3f3f46;--t0:#f4f4f5;--t1:#e4e4e7;--t2:#a1a1aa;--acc:#f59e0b;--grn:#22c55e;--amb:#fbbf24;--red:#ef4444;--org:#f97316;--brd:#3f3f46;--r:6px}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;background:var(--bg0);color:var(--t1);line-height:1.4}
.app{display:flex;flex-direction:column;height:100vh}
header{display:flex;align-items:center;padding:8px 16px;background:var(--bg1);border-bottom:1px solid var(--brd);gap:10px;flex-shrink:0}
header svg{width:28px;height:28px}
header h1{font-size:16px;font-weight:700;color:var(--t0)}
header .sub{font-size:11px;color:var(--t2)}
.main{display:flex;flex:1;overflow:hidden}
.sidebar{width:310px;min-width:310px;background:var(--bg1);border-right:1px solid var(--brd);overflow-y:auto;padding:8px;flex-shrink:0}
.sidebar::-webkit-scrollbar{width:6px}
.sidebar::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
.pnl{background:var(--bg2);border-radius:var(--r);margin-bottom:6px;overflow:hidden}
.pnl-h{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;cursor:pointer;user-select:none}
.pnl-h:hover{background:var(--bg3)}
.pnl-h h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--t2)}
.pnl-h .arr{font-size:10px;color:var(--t2);transition:transform .2s}
.pnl-h.collapsed .arr{transform:rotate(-90deg)}
.pnl-b{padding:8px 12px;border-top:1px solid var(--brd)}
.pnl-b.hide{display:none}
.pr{display:flex;align-items:center;margin-bottom:6px;gap:6px}
.pr label{width:70px;font-size:12px;color:var(--t2);flex-shrink:0}
.pr input[type=number],.pr input[type=text],.pr select{flex:1;background:var(--bg1);border:1px solid var(--brd);border-radius:4px;padding:4px 6px;color:var(--t0);font-size:12px;font-family:'SF Mono',Menlo,monospace}
.pr input:focus,.pr select:focus{outline:none;border-color:var(--acc)}
.pr select{cursor:pointer}
.tgl-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.tgl{position:relative;width:32px;height:18px;background:var(--bg3);border-radius:9px;cursor:pointer;transition:background .2s;flex-shrink:0}
.tgl.on{background:var(--acc)}
.tgl::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s}
.tgl.on::after{transform:translateX(14px)}
.tgl-row label{font-size:12px;color:var(--t2)}
.flt{border:1px solid var(--brd);border-radius:4px;margin-bottom:6px;overflow:hidden}
.flt-h{display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg3);cursor:pointer;font-size:12px}
.flt-h .tgl{width:28px;height:16px}
.flt-h .tgl::after{width:12px;height:12px}
.flt-h .tgl.on::after{transform:translateX(12px)}
.flt-h span{flex:1;color:var(--t2);font-weight:500}
.flt-b{padding:6px 8px}
.flt-b.hide{display:none}
.plot-area{flex:1;display:flex;flex-direction:column;padding:8px;gap:6px;overflow:hidden;min-width:0}
.tabs{display:flex;gap:2px;flex-shrink:0}
.tab{padding:7px 14px;border:none;border-radius:var(--r) var(--r) 0 0;background:var(--bg2);color:var(--t2);font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
.tab.act{background:var(--bg1);color:var(--acc);font-weight:700}
.tab:hover:not(.act){background:var(--bg3)}
.mbar{display:flex;gap:12px;padding:6px 10px;background:var(--bg1);border-radius:var(--r);font-size:11px;flex-wrap:wrap;flex-shrink:0}
.met{display:flex;gap:4px;align-items:center}
.met-l{color:var(--t2)}
.met-v{color:var(--t0);font-weight:700;font-family:'SF Mono',Menlo,monospace}
.met-v.g{color:var(--grn)}.met-v.w{color:var(--amb)}.met-v.b{color:var(--red)}
.charts{flex:1;display:flex;flex-direction:column;gap:6px;min-height:0}
.chwrap{flex:1;position:relative;background:var(--bg1);border-radius:var(--r);min-height:0;overflow:hidden}
.chwrap canvas{position:absolute;top:0;left:0;width:100%!important;height:100%!important}
.chwrap.hide{display:none}
.warn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--red);font-size:14px;font-weight:600;text-align:center;pointer-events:none}
@media(max-width:900px){.main{flex-direction:column}.sidebar{width:100%;min-width:auto;max-height:35vh;border-right:none;border-bottom:1px solid var(--brd)}}
#w3D{position:relative}
#w3DSplit{position:absolute;top:0;left:0;width:100%;height:100%;display:flex}
#w3DScene{flex:3;position:relative;min-width:0;overflow:hidden}
#w3DScene canvas{position:absolute!important;top:0;left:0;width:100%!important;height:100%!important}
#w3DChart{flex:2;position:relative;min-width:0;border-left:1px solid var(--brd);background:var(--bg1)}
#w3DChart canvas{position:absolute;top:0;left:0;width:100%!important;height:100%!important}
#posMarker{position:absolute;top:0;bottom:0;width:2px;background:var(--red);pointer-events:none;z-index:2;display:none}
#msd3DMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:var(--t2);font-size:14px;text-align:center;pointer-events:none;z-index:2}
#msd3DCtrl{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;background:rgba(24,24,27,.85);padding:6px 14px;border-radius:8px;border:1px solid var(--brd);z-index:2}
#msd3DCtrl button{background:var(--bg3);border:1px solid var(--brd);color:var(--t0);border-radius:4px;padding:4px 10px;cursor:pointer;font-size:14px}
#msd3DCtrl button:hover{background:var(--bg2);border-color:var(--acc)}
#msd3DCtrl select{background:var(--bg1);border:1px solid var(--brd);color:var(--t0);border-radius:4px;padding:2px 4px;font-size:11px;font-family:'SF Mono',Menlo,monospace;cursor:pointer}
#msd3DTime{color:var(--t2);font-size:11px;font-family:'SF Mono',Menlo,monospace;min-width:100px;text-align:center}
#msd3DProgress{width:120px;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
#msd3DBar{height:100%;background:var(--acc);width:0;transition:none}
#rnBtn{background:var(--bg2);border:1px solid var(--brd);color:var(--t2);border-radius:6px;padding:4px 10px;font-size:12px;cursor:pointer;transition:all .15s;font-weight:500}
#rnBtn:hover{color:var(--t0);border-color:var(--t2)}
#rnOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;align-items:center;justify-content:center}
#rnOverlay.show{display:flex}
#rnModal{background:var(--bg1);border:1px solid var(--brd);border-radius:10px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto;padding:20px 24px;box-shadow:0 16px 48px rgba(0,0,0,.5)}
#rnModal::-webkit-scrollbar{width:6px}
#rnModal::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:3px}
#rnModal h2{font-size:16px;color:var(--t0);margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
#rnModal h2 button{background:none;border:none;color:var(--t2);cursor:pointer;font-size:18px;line-height:1}
#rnModal h2 button:hover{color:var(--t0)}
.rn-ver{margin-bottom:16px}
.rn-ver h3{font-size:13px;color:var(--acc);font-weight:700;margin-bottom:4px}
.rn-ver .rn-date{font-size:10px;color:var(--t2);margin-bottom:6px;font-family:'SF Mono',Menlo,monospace}
.rn-ver ul{margin:0;padding-left:18px;list-style:disc}
.rn-ver li{font-size:12px;color:var(--t1);margin-bottom:3px;line-height:1.5}
.rn-ver code{background:var(--bg2);padding:1px 5px;border-radius:3px;font-size:11px;color:var(--acc);font-family:'SF Mono',Menlo,monospace}
</style>
</head>
<body>
<div class="app">
<header>
<svg viewBox="0 0 512 512"><rect width="512" height="512" rx="64" fill="#09090b"/><path d="M80 350Q160 350 200 200Q240 50 280 250Q320 400 400 180L430 180" stroke="#f59e0b" stroke-width="16" fill="none" stroke-linecap="round"/></svg>
<div><h1>Control Loop Tuner</h1><div class="sub">PID + Filters &middot; Bode &amp; Time Response</div></div>
<nav style="margin-left:auto;display:flex;gap:6px"><a href="index.html" style="font-size:12px;padding:4px 10px;border-radius:6px;text-decoration:none;color:#f59e0b;border:1px solid #f59e0b;font-weight:700">SISO</a><a href="mimo.html" style="font-size:12px;padding:4px 10px;border-radius:6px;text-decoration:none;color:#a1a1aa;border:1px solid #3f3f46;transition:all .15s" onmouseover="this.style.color='#f4f4f5';this.style.borderColor='#a1a1aa'" onmouseout="this.style.color='#a1a1aa';this.style.borderColor='#3f3f46'">MIMO</a><button id="rnBtn" onclick="$('rnOverlay').classList.add('show')">Release Notes</button></nav>
</header>
<div id="rnOverlay" onclick="if(event.target===this)this.classList.remove('show')">
<div id="rnModal">
<h2>Release Notes <button onclick="$('rnOverlay').classList.remove('show')">&times;</button></h2>
<div class="rn-ver"><h3>v1.2 &mdash; Unified Simulator</h3><div class="rn-date">2026-02-11</div><ul>
<li>Consolidated Step Response, Impulse Response, old Simulator, and 3D View into two clean tabs: <b>Bode Plot</b> and <b>Simulator</b></li>
<li>Simulator shows side-by-side 3D scene (<code>w3DScene</code>) and 2D Chart.js time-domain plot (<code>w3DChart</code>) in a flex layout</li>
<li>2D chart plots both <b>Input r(t)</b> (dashed blue) and <b>Output y(t)</b> (solid amber) with animated marker dots and red time indicator synced to 3D animation</li>
<li>Simulator uses <code>simCustom()</code> with <code>buildInputFn()</code> &mdash; supports step, ramp, sine, square, and sawtooth signals from the GUI signal selector</li>
<li>Mass-Spring-Damper (G(s) = 1/(ms&sup2;+cs+k)) set as default plant model; PID starts disabled for open-loop behavior</li>
</ul>
<p style="font-size:11px;color:var(--t2);margin:6px 0 4px;font-weight:600">Bug fixes:</p><ul>
<li><b>Bode/Simulator DC gain mismatch</b>: Bode plotted open-loop <code>sys.ol</code> but Simulator used closed-loop <code>sys.cl</code>, causing e.g. MSD 0&thinsp;dB (gain=1) in Bode but 0.5&thinsp;m steady-state in Simulator. Fixed <code>updCharts()</code> to select <code>sys.ol</code> or <code>sys.cl</code> based on PID toggle state</li>
<li><b>3D view ignored signal type</b>: Previously always used <code>simStep()</code> unit step regardless of GUI settings. Changed to use <code>simCustom()</code> data matching the selected input signal and PID/filter configuration</li>
<li>Chart title now dynamically shows <b>&ldquo;Open Loop Response&rdquo;</b> or <b>&ldquo;Closed Loop Response&rdquo;</b> so the active mode is always visible</li>
</ul></div>
<div class="rn-ver"><h3>v1.1 &mdash; 3D Mass-Spring-Damper</h3><div class="rn-date">2026-02-08</div><ul>
<li>Added <code>init3D()</code>: creates Three.js r128 WebGL scene with wall, mass block (amber), force arrow (red), damper with piston (blue), and ground plane with grid</li>
<li>Spring rendered as 3D helical coil via <code>helixCurve()</code> using <code>TubeGeometry</code> + <code>CatmullRomCurve3</code>; dynamically rebuilt by <code>updSpring(mx)</code> as mass moves</li>
<li>Damper piston rod scales/repositions via <code>updDamper(mx)</code>; force arrow length tracks instantaneous input force</li>
<li>RK4-integrated time response drives animation: <code>anim3D()</code> interpolates y(t) and u(t) arrays at current playback time, calls <code>setMassPos()</code></li>
<li>Custom mouse orbit controls (drag to rotate, scroll to zoom) &mdash; no OrbitControls dependency</li>
<li>Playback controls: play/pause, restart, speed selector (0.25&times;&ndash;4&times;), progress bar with elapsed time readout</li>
<li>Metrics bar shows m, c, k, &omega;<sub>n</sub>, and &zeta; when Simulator tab is active</li>
<li>Fallback message when a non-MSD plant model is selected</li>
</ul></div>
<div class="rn-ver"><h3>v1.0 &mdash; Initial Release</h3><div class="rn-date">2026-02-07</div><ul>
<li>SISO control loop tuner: <code>buildSystem()</code> constructs open-loop L(s) = C(s)&middot;G(s)&middot;Filters and closed-loop CL(s) = L/(1+L)</li>
<li>MIMO state-space tuner on separate page (<code>mimo.html</code>) with A, B, C, D matrix input</li>
<li>PID controller (<code>buildPID()</code>) with Kp, Ki, Kd; derivative filter coefficient N</li>
<li>Plant models: custom transfer function (numerator/denominator coefficients), mass-spring-damper, DC motor, thermal system</li>
<li>Filter chain: low-pass, high-pass, notch, and lead-lag &mdash; each independently togglable</li>
<li>Bode plots via <code>freqResp()</code>: log-spaced frequency sweep, magnitude (dB) and phase (&deg;) on separate charts</li>
<li>Stability metrics via <code>bodeMetrics()</code>: gain margin, phase margin, gain/phase crossover frequencies, bandwidth</li>
<li>Time-domain simulation: <code>tf2ss()</code> state-space conversion, <code>simStep()</code> / <code>simCustom()</code> with RK4 integration</li>
<li>Polynomial math utilities: <code>polyMul()</code>, <code>polyAdd()</code>, <code>polyEval()</code> for transfer function algebra</li>
<li>Sidebar panel UI with collapsible sections, toggle switches, real-time parameter updates via <code>sched()</code> debounce</li>
<li>PWA: service worker (<code>sw.js</code>) with cache-first strategy; <code>manifest.json</code> for installability</li>
</ul></div>
</div>
</div>
<div class="main">
<aside class="sidebar">

<!-- Simulation Settings -->
<div class="pnl"><div class="pnl-h" onclick="tP(this)"><h3>Simulation</h3><span class="arr">&#9660;</span></div>
<div class="pnl-b">
<div class="pr"><label>T_end (s)</label><input type="number" id="simTend" value="10" min="0.1" step="1"></div>
<div class="pr"><label>f_min (Hz)</label><input type="number" id="simFmin" value="0.001" min="0.0001" step="0.001"></div>
<div class="pr"><label>f_max (Hz)</label><input type="number" id="simFmax" value="200" min="0.1" step="10"></div>
</div></div>

<!-- Time Simulator -->
<div class="pnl"><div class="pnl-h" onclick="tP(this)"><h3>Time Simulator</h3><span class="arr">&#9660;</span></div>
<div class="pnl-b">
<div class="pr"><label>Mode</label><select id="simLoopMode" onchange="updLoopMode();sched()"><option value="ol">Open Loop</option><option value="cl">Closed Loop</option></select></div>
<div class="pr"><label id="lblSigType">Force</label><select id="simSigType" onchange="updSimUI();sched()"><option value="step">Step</option><option value="ramp">Ramp</option><option value="sine">Sine</option><option value="square">Square</option><option value="sawtooth">Sawtooth</option></select></div>
<div class="pr"><label id="lblSigAmp">Amplitude</label><input type="number" id="simSigAmp" value="1" step="0.1"></div>
<div class="pr" id="rowSigFreq" style="display:none"><label>Freq (Hz)</label><input type="number" id="simSigFreq" value="1" min="0.001" step="0.1"></div>
<div class="pr" id="rowSigDelay"><label>Delay (s)</label><input type="number" id="simSigDelay" value="0" min="0" step="0.1"></div>
<div class="pr" id="rowSigDuty" style="display:none"><label>Duty (%)</label><input type="number" id="simSigDuty" value="50" min="1" max="99" step="5"></div>
<div class="pr"><label>Offset</label><input type="number" id="simSigOff" value="0" step="0.1"></div>
<div class="pr"><label>x&#x2080;</label><input type="text" id="simX0" value="0" placeholder="0, 0, ..."></div>
</div></div>

<!-- Plant -->
<div class="pnl"><div class="pnl-h" onclick="tP(this)"><h3>Plant Model G(s)</h3><span class="arr">&#9660;</span></div>
<div class="pnl-b">
<div class="pr"><label>Model</label><select id="plantModel" onchange="updPlantUI();sched()"><option value="generic">Generic</option><option value="msd" selected>Mass-Spring-Damper</option><option value="rl">RL Circuit</option><option value="rlc">RLC Circuit</option></select></div>
<div class="pr" id="rowOrd"><label>Order</label><select id="plantOrd" onchange="updPlantUI();sched()"><option value="1">1st Order</option><option value="2" selected>2nd Order</option></select></div>
<div class="pr" id="rowK"><label>K</label><input type="number" id="plantK" value="1" step="0.1"></div>
<div class="pr" id="rowTau" style="display:none"><label>&tau; (s)</label><input type="number" id="plantTau" value="1" min="0.001" step="0.1"></div>
<div class="pr" id="rowWn"><label>&omega;n (rad/s)</label><input type="number" id="plantWn" value="1" min="0.001" step="0.1"></div>
<div class="pr" id="rowZeta"><label>&zeta;</label><input type="number" id="plantZeta" value="0.5" min="0" max="20" step="0.05"></div>
<div class="pr" id="rowM" style="display:none"><label>m (kg)</label><input type="number" id="plantM" value="1" min="0.001" step="0.1"></div>
<div class="pr" id="rowDamp" style="display:none"><label>c (Ns/m)</label><input type="number" id="plantDamp" value="1" min="0" step="0.1"></div>
<div class="pr" id="rowSpK" style="display:none"><label>k (N/m)</label><input type="number" id="plantSpK" value="1" min="0.001" step="0.1"></div>
<div class="pr" id="rowR" style="display:none"><label>R (&Omega;)</label><input type="number" id="plantR" value="100" min="0.001" step="1"></div>
<div class="pr" id="rowL" style="display:none"><label>L (H)</label><input type="number" id="plantL" value="0.1" min="0.001" step="0.01"></div>
<div class="pr" id="rowCap" style="display:none"><label>C (F)</label><input type="number" id="plantCap" value="0.0001" min="1e-9" step="0.0001"></div>
</div></div>

<!-- PID -->
<div class="pnl"><div class="pnl-h" onclick="tP(this)"><h3>PID Controller C(s)</h3><span class="arr">&#9660;</span></div>
<div class="pnl-b">
<div class="tgl-row"><div class="tgl" id="pidTgl" onclick="tglS(this)"></div><label>Enabled</label></div>
<div class="pr"><label>Kp</label><input type="number" id="pidKp" value="5" step="0.1"></div>
<div class="pr"><label>fi (Hz)</label><input type="number" id="pidFi" value="0.08" min="0" step="0.01"></div>
<div class="pr"><label>fd (Hz)</label><input type="number" id="pidFd" value="0.8" min="0" step="0.1"></div>
<div class="pr"><label>T_f (s)</label><input type="number" id="pidTf" value="0.01" min="0.001" step="0.01"></div>
</div></div>

<!-- Filters -->
<div class="pnl"><div class="pnl-h" onclick="tP(this)"><h3>Filters F(s)</h3><span class="arr">&#9660;</span></div>
<div class="pnl-b" id="filtersBody"></div>
</div>

</aside>
<main class="plot-area">
<div class="tabs">
<button class="tab act" data-tab="bode" onclick="setTab('bode',this)">Bode Plot</button>
<button class="tab" data-tab="3d" onclick="setTab('3d',this)">Simulator</button>
</div>
<div class="mbar" id="mbar"></div>
<div class="charts">
<div class="chwrap" id="wMag"><canvas id="cMag"></canvas></div>
<div class="chwrap" id="wPhase"><canvas id="cPhase"></canvas></div>
<div class="chwrap hide" id="w3D">
<div id="w3DSplit">
<div id="w3DScene">
<div id="msd3DMsg" class="hide">Select <b>Mass-Spring-Damper</b> plant model to view 3D visualization</div>
<div id="msd3DCtrl" class="hide">
<button onclick="msd3DRestart()" title="Restart">&#8634;</button>
<button onclick="msd3DToggle()" id="msd3DPlayBtn" title="Play/Pause">&#9208;</button>
<div id="msd3DProgress"><div id="msd3DBar"></div></div>
<span id="msd3DTime">0.00s</span>
<select id="msd3DSpeedSel" onchange="msd3DSpd=+this.value" title="Speed"><option value="0.25">0.25x</option><option value="0.5">0.5x</option><option value="1" selected>1x</option><option value="2">2x</option><option value="4">4x</option></select>
</div>
</div>
<div id="w3DChart"><canvas id="c3DPos"></canvas><div id="posMarker"></div></div>
</div>
</div>
</div>
</main>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
/* ========== MATH UTILITIES ========== */
const Cx={
  n:(r,i=0)=>({re:r,im:i}),
  add:(a,b)=>({re:a.re+b.re,im:a.im+b.im}),
  sub:(a,b)=>({re:a.re-b.re,im:a.im-b.im}),
  mul:(a,b)=>({re:a.re*b.re-a.im*b.im,im:a.re*b.im+a.im*b.re}),
  div:(a,b)=>{const d=b.re*b.re+b.im*b.im;return{re:(a.re*b.re+a.im*b.im)/d,im:(a.im*b.re-a.re*b.im)/d}},
  abs:a=>Math.hypot(a.re,a.im),
  arg:a=>Math.atan2(a.im,a.re)
};

// Polynomials in ascending order: [a0, a1, a2, ...]
function pMul(p,q){
  const r=new Array(p.length+q.length-1).fill(0);
  for(let i=0;i<p.length;i++)for(let j=0;j<q.length;j++)r[i+j]+=p[i]*q[j];
  return r;
}
function pAdd(p,q){
  const n=Math.max(p.length,q.length),r=new Array(n).fill(0);
  for(let i=0;i<p.length;i++)r[i]+=p[i];
  for(let i=0;i<q.length;i++)r[i]+=q[i];
  return r;
}
function pEval(p,s){
  let r=Cx.n(0);
  for(let i=p.length-1;i>=0;i--)r=Cx.add(Cx.mul(r,s),Cx.n(p[i]));
  return r;
}
function pTrim(p){
  let i=p.length-1;
  while(i>0&&Math.abs(p[i])<1e-15)i--;
  return p.slice(0,i+1);
}

/* ========== TRANSFER FUNCTION BUILDERS ========== */
function plantTF(){
  const model=$('plantModel').value;
  if(model==='msd'){
    const m=Math.max(+$('plantM').value,1e-6),c=Math.max(+$('plantDamp').value,0),k=Math.max(+$('plantSpK').value,1e-6);
    return{n:[1],d:[k,c,m]};
  }
  if(model==='rl'){
    const R=Math.max(+$('plantR').value,1e-6),L=Math.max(+$('plantL').value,1e-6);
    return{n:[1],d:[R,L]};
  }
  if(model==='rlc'){
    const R=Math.max(+$('plantR').value,1e-6),L=Math.max(+$('plantL').value,1e-6),C=Math.max(+$('plantCap').value,1e-12);
    return{n:[1],d:[1,R*C,L*C]};
  }
  const ord=+$('plantOrd').value, K=+$('plantK').value;
  if(ord===1){const tau=+$('plantTau').value;return{n:[K],d:[1,Math.max(tau,1e-6)]}}
  const wn=Math.max(+$('plantWn').value,1e-6),z=+$('plantZeta').value;
  return{n:[K*wn*wn],d:[wn*wn,2*z*wn,1]};
}

function pidTF(){
  if(!$('pidTgl').classList.contains('on'))return{n:[1],d:[1]};
  const Kp=+$('pidKp').value,fi=+$('pidFi').value,fd=+$('pidFd').value,Tf=Math.max(+$('pidTf').value,1e-6);
  const wi=2*Math.PI*fi,wd=2*Math.PI*fd,Ki=Kp*wi,Kd=wd>1e-15?Kp/wd:0;
  if(Math.abs(Ki)<1e-15&&Math.abs(Kd)<1e-15)return{n:[Kp||1e-10],d:[1]};
  if(Math.abs(Ki)<1e-15)return{n:[Kp,Kp*Tf+Kd],d:[1,Tf]};
  return{n:[Ki,Kp+Ki*Tf,Kp*Tf+Kd],d:[0,1,Tf]};
}

const FTYPES=['lowpass','highpass','bandpass','notch','leadlag'];
const FLABELS=['Low-Pass','High-Pass','Band-Pass','Notch','Lead-Lag'];
const FPARAM1=['&omega;c','&omega;c','&omega;0','&omega;n','&omega;z'];
const FPARAM2=['&zeta;','&zeta;','&zeta;','&zeta;','&omega;p'];
const FDEF1=[10,10,10,10,10];
const FDEF2=[0.707,0.707,0.5,0.1,100];

function filterTF(i){
  const el=$('fTgl'+i);
  if(!el||!el.classList.contains('on'))return{n:[1],d:[1]};
  const t=$('fType'+i).value,p1=Math.max(+$('fP1_'+i).value,1e-6),p2=+$('fP2_'+i).value;
  switch(t){
    case'lowpass':return{n:[p1*p1],d:[p1*p1,2*p2*p1,1]};
    case'highpass':return{n:[0,0,1],d:[p1*p1,2*p2*p1,1]};
    case'bandpass':return{n:[0,2*p2*p1],d:[p1*p1,2*p2*p1,1]};
    case'notch':return{n:[p1*p1,0,1],d:[p1*p1,2*p2*p1,1]};
    case'leadlag':return{n:[1,1/p1],d:[1,1/Math.max(p2,1e-6)]};
    default:return{n:[1],d:[1]};
  }
}

/* ========== SYSTEM COMPUTATION ========== */
function buildSystem(){
  const g=plantTF(),c=pidTF();
  let cfN=c.n,cfD=c.d;
  let oN=pMul(c.n,g.n),oD=pMul(c.d,g.d);
  for(let i=0;i<5;i++){const f=filterTF(i);oN=pMul(oN,f.n);oD=pMul(oD,f.d);cfN=pMul(cfN,f.n);cfD=pMul(cfD,f.d);}
  const clD=pTrim(pAdd(oD,oN)),clN=pTrim(oN);
  // TF from r to controller output (force): C(s)*F(s) / (1+L(s)) = cfN*g.d / clD
  const cuN=pTrim(pMul(cfN,g.d));
  return{ol:{n:pTrim(oN),d:pTrim(oD)},cl:{n:clN,d:clD},cu:{n:cuN,d:clD}};
}

/* ========== FREQUENCY RESPONSE ========== */
function freqResp(tf,freqs){
  const m=[],ph=[];
  for(const w of freqs){
    const jw=Cx.n(0,w),H=Cx.div(pEval(tf.n,jw),pEval(tf.d,jw));
    m.push(20*Math.log10(Math.max(Cx.abs(H),1e-30)));
    ph.push(Cx.arg(H)*180/Math.PI);
  }
  // unwrap phase
  for(let i=1;i<ph.length;i++){
    while(ph[i]-ph[i-1]>180)ph[i]-=360;
    while(ph[i]-ph[i-1]<-180)ph[i]+=360;
  }
  return{m,ph};
}

/* ========== STATE SPACE + RK4 SIMULATION ========== */
function tf2ss(num,den){
  den=pTrim([...den]);num=[...num];
  const n=den.length-1;
  if(n===0)return{A:[],B:[],C:[],D:num[0]/(den[0]||1e-30),n:0};
  const an=den[n];
  den=den.map(x=>x/an);num=num.map(x=>x/an);
  while(num.length<=n)num.push(0);
  const D=num[n];
  const A=Array.from({length:n},()=>new Float64Array(n));
  for(let i=0;i<n-1;i++)A[i][i+1]=1;
  for(let i=0;i<n;i++)A[n-1][i]=-den[i];
  const B=new Float64Array(n);B[n-1]=1;
  const C=new Float64Array(n);
  for(let i=0;i<n;i++)C[i]=num[i]-D*den[i];
  return{A,B,C,D,n};
}

function simStep(ss,tEnd,nPts){
  const{A,B,C:Cv,D,n}=ss;
  if(n===0){const t=Array.from({length:nPts},(_, i)=>i*tEnd/(nPts-1));return{t,y:t.map(()=>D)};}
  const dt=tEnd/(nPts-1),x=new Float64Array(n),ts=[],ys=[];
  function dx(s,u){const r=new Float64Array(n);for(let i=0;i<n;i++){for(let j=0;j<n;j++)r[i]+=A[i][j]*s[j];r[i]+=B[i]*u;}return r;}
  function out(s,u){let y=D*u;for(let i=0;i<n;i++)y+=Cv[i]*s[i];return y;}
  let blow=false;
  for(let k=0;k<nPts;k++){
    const u=1;ts.push(k*dt);ys.push(out(x,u));
    if(Math.abs(ys[ys.length-1])>1e8){blow=true;for(let j=k+1;j<nPts;j++){ts.push(j*dt);ys.push(NaN);}break;}
    const k1=dx(x,u);
    const x2=new Float64Array(n);for(let i=0;i<n;i++)x2[i]=x[i]+dt/2*k1[i];
    const k2=dx(x2,u);
    const x3=new Float64Array(n);for(let i=0;i<n;i++)x3[i]=x[i]+dt/2*k2[i];
    const k3=dx(x3,u);
    const x4=new Float64Array(n);for(let i=0;i<n;i++)x4[i]=x[i]+dt*k3[i];
    const k4=dx(x4,u);
    for(let i=0;i<n;i++)x[i]+=dt/6*(k1[i]+2*k2[i]+2*k3[i]+k4[i]);
  }
  return{t:ts,y:ys,unstable:blow};
}

function simImpulse(ss,tEnd,nPts){
  const{A,B,C:Cv,D,n}=ss;
  if(n===0){const t=Array.from({length:nPts},(_,i)=>i*tEnd/(nPts-1));return{t,y:t.map(()=>0)};}
  const dt=tEnd/(nPts-1),x=Float64Array.from(B),ts=[],ys=[];
  function dx(s){const r=new Float64Array(n);for(let i=0;i<n;i++)for(let j=0;j<n;j++)r[i]+=A[i][j]*s[j];return r;}
  let blow=false;
  for(let k=0;k<nPts;k++){
    let y=0;for(let i=0;i<n;i++)y+=Cv[i]*x[i];
    ts.push(k*dt);ys.push(y);
    if(Math.abs(y)>1e8){blow=true;for(let j=k+1;j<nPts;j++){ts.push(j*dt);ys.push(NaN);}break;}
    const k1=dx(x);
    const x2=new Float64Array(n);for(let i=0;i<n;i++)x2[i]=x[i]+dt/2*k1[i];
    const k2=dx(x2);
    const x3=new Float64Array(n);for(let i=0;i<n;i++)x3[i]=x[i]+dt/2*k2[i];
    const k3=dx(x3);
    const x4=new Float64Array(n);for(let i=0;i<n;i++)x4[i]=x[i]+dt*k3[i];
    const k4=dx(x4);
    for(let i=0;i<n;i++)x[i]+=dt/6*(k1[i]+2*k2[i]+2*k3[i]+k4[i]);
  }
  return{t:ts,y:ys,unstable:blow};
}

function simCustom(ss,uFn,tEnd,nPts,x0){
  const{A,B,C:Cv,D,n}=ss;
  if(n===0){const t=Array.from({length:nPts},(_,i)=>i*tEnd/(nPts-1));return{t,y:t.map(ti=>D*uFn(ti)),u:t.map(ti=>uFn(ti))};}
  const dt=tEnd/(nPts-1),x=new Float64Array(n);
  for(let i=0;i<n&&i<x0.length;i++)x[i]=x0[i];
  const ts=[],ys=[],us=[];
  function dx(s,u){const r=new Float64Array(n);for(let i=0;i<n;i++){for(let j=0;j<n;j++)r[i]+=A[i][j]*s[j];r[i]+=B[i]*u;}return r;}
  function out(s,u){let y=D*u;for(let i=0;i<n;i++)y+=Cv[i]*s[i];return y;}
  let blow=false;
  for(let k=0;k<nPts;k++){
    const t=k*dt,u=uFn(t);
    ts.push(t);us.push(u);ys.push(out(x,u));
    if(Math.abs(ys[ys.length-1])>1e8){blow=true;for(let j=k+1;j<nPts;j++){ts.push(j*dt);ys.push(NaN);us.push(uFn(j*dt));}break;}
    const k1=dx(x,u),um=uFn(t+dt/2);
    const x2=new Float64Array(n);for(let i=0;i<n;i++)x2[i]=x[i]+dt/2*k1[i];
    const k2=dx(x2,um);
    const x3=new Float64Array(n);for(let i=0;i<n;i++)x3[i]=x[i]+dt/2*k2[i];
    const k3=dx(x3,um);
    const ue=uFn(t+dt);
    const x4=new Float64Array(n);for(let i=0;i<n;i++)x4[i]=x[i]+dt*k3[i];
    const k4=dx(x4,ue);
    for(let i=0;i<n;i++)x[i]+=dt/6*(k1[i]+2*k2[i]+2*k3[i]+k4[i]);
  }
  return{t:ts,y:ys,u:us,unstable:blow};
}

/* ========== METRICS ========== */
function stepMetrics(ts,ys){
  const valid=ys.filter(v=>isFinite(v));
  if(valid.length<20)return{unstable:true};
  const tail=valid.slice(-Math.max(Math.floor(valid.length*.1),5));
  const fv=tail.reduce((a,b)=>a+b,0)/tail.length;
  if(Math.abs(fv)<1e-10)return{fv:0,sse:1};
  const pk=Math.max(...valid),os=fv>0?Math.max(0,(pk-fv)/fv*100):0;
  let rt;const i10=ts.findIndex((_,i)=>ys[i]>=.1*fv),i90=ts.findIndex((_,i)=>ys[i]>=.9*fv);
  if(i10>=0&&i90>=0)rt=ts[i90]-ts[i10];
  let st;for(let i=valid.length-1;i>=0;i--){if(Math.abs(valid[i]-fv)>.02*Math.abs(fv)){st=ts[Math.min(i+1,ts.length-1)];break;}}
  return{fv,sse:Math.abs(1-fv),os,rt,st};
}

function bodeMetrics(f,m,ph){
  let gcf,pm,pcf,gm;
  for(let i=1;i<m.length;i++){
    if(!gcf&&((m[i-1]>=0&&m[i]<0)||(m[i-1]<0&&m[i]>=0))){
      const t=(0-m[i-1])/(m[i]-m[i-1]);
      gcf=f[i-1]*Math.pow(f[i]/f[i-1],t);
      pm=180+(ph[i-1]+t*(ph[i]-ph[i-1]));
    }
  }
  for(let i=1;i<ph.length;i++){
    if(!pcf&&((ph[i-1]>=-180&&ph[i]<-180)||(ph[i-1]<-180&&ph[i]>=-180))){
      const t=(-180-ph[i-1])/(ph[i]-ph[i-1]);
      pcf=f[i-1]*Math.pow(f[i]/f[i-1],t);
      gm=-(m[i-1]+t*(m[i]-m[i-1]));
    }
  }
  return{gcf,pm,pcf,gm};
}

/* ========== CHART MANAGEMENT ========== */
const CS={};
const COLS={main:'#f59e0b',ref:'#3b82f688',imp:'#22c55e',mag:'#f59e0b',phase:'#f97316',zero:'#52525b44'};

Chart.defaults.color='#a1a1aa';
Chart.defaults.borderColor='#27272a';
Chart.defaults.font.size=11;
Chart.defaults.font.family="'SF Mono',Menlo,monospace";

function mkChart(id,cfg){
  if(CS[id]){CS[id].destroy();}
  CS[id]=new Chart($(id).getContext('2d'),cfg);
  return CS[id];
}

function updCharts(sys){
  const tEnd=Math.max(+$('simTend').value||10,.1);
  const fMin=Math.max(+$('simFmin').value||.001,1e-6);
  const fMax=Math.max(+$('simFmax').value||200,fMin*10);
  const wMin=fMin*2*Math.PI,wMax=fMax*2*Math.PI;
  const nPts=2000,nFreq=600;

  // Generate freq array (log-spaced)
  const freqs=[];
  const lMin=Math.log10(wMin),lMax=Math.log10(wMax);
  for(let i=0;i<nFreq;i++)freqs.push(Math.pow(10,lMin+i*(lMax-lMin)/(nFreq-1)));

  // Use closed-loop or open-loop based on mode selector
  const isCL=$('simLoopMode').value==='cl';
  const sysTF=isCL?sys.cl:sys.ol;
  const loopLabel=isCL?'Closed Loop':'Open Loop';
  const ss=tf2ss(sysTF.n,sysTF.d);
  const stepData=simStep(ss,tEnd,nPts);lastStepData=stepData;
  const uFn=buildInputFn(),x0=parseX0();
  const simData=simCustom(ss,uFn,tEnd,nPts,x0);
  // In closed-loop mode, compute controller output (force into plant)
  let forceData=null;
  if(isCL){
    const cuSS=tf2ss(sys.cu.n,sys.cu.d);
    forceData=simCustom(cuSS,uFn,tEnd,nPts,parseX0());
  }

  // Open-loop freq response
  const fr=freqResp(sys.ol,freqs);

  // Metrics
  const bm=bodeMetrics(freqs,fr.m,fr.ph);
  updMetrics(bm,simData);

  // Bode Magnitude
  const TP=2*Math.PI;
  mkChart('cMag',{
    type:'scatter',
    data:{datasets:[
      {label:'0 dB',data:[{x:fMin,y:0},{x:fMax,y:0}],showLine:true,borderColor:COLS.zero,borderWidth:1,borderDash:[6,3],pointRadius:0,order:1},
      {label:'|L(j\u03c9)| (dB)',data:freqs.map((w,i)=>({x:w/TP,y:fr.m[i]})),showLine:true,borderColor:COLS.mag,borderWidth:2,pointRadius:0,order:0},
      ...(bm.gcf?[{label:'Gain Crossover',data:[{x:bm.gcf/TP,y:0}],pointRadius:6,pointBackgroundColor:COLS.ref,pointBorderColor:COLS.ref,showLine:false}]:[]),
      ...(bm.pcf?[{label:'Phase Crossover',data:[{x:bm.pcf/TP,y:-(bm.gm||0)}],pointRadius:6,pointBackgroundColor:COLS.ref,pointBorderColor:COLS.ref,pointStyle:'triangle',showLine:false}]:[])
    ]},
    options:scatterOpts('Frequency (Hz)','Magnitude (dB)',true)
  });

  // Bode Phase
  mkChart('cPhase',{
    type:'scatter',
    data:{datasets:[
      {label:'-180\u00b0',data:[{x:fMin,y:-180},{x:fMax,y:-180}],showLine:true,borderColor:COLS.zero,borderWidth:1,borderDash:[6,3],pointRadius:0,order:1},
      {label:'\u2220L(j\u03c9) (\u00b0)',data:freqs.map((w,i)=>({x:w/TP,y:fr.ph[i]})),showLine:true,borderColor:COLS.phase,borderWidth:2,pointRadius:0,order:0},
      ...(bm.gcf?[{label:'PM point',data:[{x:bm.gcf/TP,y:(bm.pm||0)-180}],pointRadius:6,pointBackgroundColor:COLS.ref,pointBorderColor:COLS.ref,showLine:false}]:[])
    ]},
    options:scatterOpts('Frequency (Hz)','Phase (\u00b0)',true)
  });

  // 3D MSD visualization
  if(curTab==='3d')upd3D(simData,loopLabel,forceData);
}

function scatterOpts(xLab,yLab,logX,unstable){
  return{
    responsive:true,maintainAspectRatio:false,animation:{duration:0},
    plugins:{legend:{display:false},tooltip:{mode:'nearest',intersect:false}},
    scales:{
      x:{type:logX?'logarithmic':'linear',title:{display:true,text:xLab,color:'#a1a1aa'},grid:{color:'#27272a'},ticks:{color:'#52525b'}},
      y:{type:'linear',title:{display:true,text:yLab,color:'#a1a1aa'},grid:{color:'#27272a'},ticks:{color:'#52525b'}}
    }
  };
}

function updMetrics(bm,simData){
  const mb=$('mbar');
  let h='';
  if(curTab==='3d'){
    if($('plantModel').value==='msd'){
      const m=+$('plantM').value,c=+$('plantDamp').value,k=+$('plantSpK').value;
      const wn=Math.sqrt(k/m),zeta=c/(2*Math.sqrt(k*m));
      h+=met('m',m.toFixed(2)+' kg','');h+=met('c',c.toFixed(2)+' Ns/m','');h+=met('k',k.toFixed(2)+' N/m','');
      h+=met('&omega;<sub>n</sub>',wn.toFixed(2)+' rad/s','');h+=met('&zeta;',zeta.toFixed(3),zeta<1?'g':zeta>1?'w':'');
    }else h+='<div class="met"><span class="met-l">Select Mass-Spring-Damper model for 3D view</span></div>';
  }else{
    h+=met('GM',bm.gm!==undefined?bm.gm.toFixed(1)+' dB':'&infin;',bm.gm===undefined||bm.gm>6?'g':bm.gm>0?'w':'b');
    h+=met('PM',bm.pm!==undefined?bm.pm.toFixed(1)+'&deg;':'--',bm.pm===undefined?'':bm.pm>45?'g':bm.pm>0?'w':'b');
    h+=met('f<sub>gc</sub>',bm.gcf!==undefined?(bm.gcf/(2*Math.PI)).toFixed(2)+' Hz':'--','');
    h+=met('f<sub>pc</sub>',bm.pcf!==undefined?(bm.pcf/(2*Math.PI)).toFixed(2)+' Hz':'--','');
  }
  mb.innerHTML=h;
}
function met(l,v,c){return`<div class="met"><span class="met-l">${l}</span><span class="met-v ${c}">${v}</span></div>`;}

/* ========== UI LOGIC ========== */
const $=id=>document.getElementById(id);
let curTab='bode',updTimer,lastStepData=null;

function tP(h){
  const b=h.nextElementSibling;
  b.classList.toggle('hide');
  h.classList.toggle('collapsed');
}
function tglS(el){
  el.classList.toggle('on');
  // Keep loop mode in sync when PID toggle is changed directly
  if(el.id==='pidTgl'){
    $('simLoopMode').value=el.classList.contains('on')?'cl':'ol';
    updSimUI();
  }
  sched();
}
function updPlantUI(){
  const model=$('plantModel').value;
  const isGen=model==='generic',isMSD=model==='msd',isRL=model==='rl',isRLC=model==='rlc';
  const is1=isGen&&+$('plantOrd').value===1;
  $('rowOrd').style.display=isGen?'flex':'none';
  $('rowK').style.display=isGen?'flex':'none';
  $('rowTau').style.display=is1?'flex':'none';
  $('rowWn').style.display=isGen&&!is1?'flex':'none';
  $('rowZeta').style.display=isGen&&!is1?'flex':'none';
  $('rowM').style.display=isMSD?'flex':'none';
  $('rowDamp').style.display=isMSD?'flex':'none';
  $('rowSpK').style.display=isMSD?'flex':'none';
  $('rowR').style.display=isRL||isRLC?'flex':'none';
  $('rowL').style.display=isRL||isRLC?'flex':'none';
  $('rowCap').style.display=isRLC?'flex':'none';
  updSimUI();
}
function setTab(tab,btn){
  curTab=tab;
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('act'));
  btn.classList.add('act');
  $('wMag').classList.toggle('hide',tab!=='bode');
  $('wPhase').classList.toggle('hide',tab!=='bode');
  $('w3D').classList.toggle('hide',tab!=='3d');
  // Trigger resize after show
  setTimeout(()=>{Object.values(CS).forEach(c=>c.resize());if(tab==='3d')resize3D();},50);
  update();
}
function sched(){clearTimeout(updTimer);updTimer=setTimeout(update,80);}
function update(){
  try{const sys=buildSystem();updCharts(sys);}
  catch(e){console.error('Update error:',e);}
}

// Build filter UI
function buildFilters(){
  let h='';
  for(let i=0;i<5;i++){
    h+=`<div class="flt"><div class="flt-h" onclick="tFlt(${i})">
      <div class="tgl" id="fTgl${i}" onclick="event.stopPropagation();tglS(this)"></div>
      <span>Filter ${i+1}</span><span class="arr" id="fArr${i}" style="font-size:10px;color:var(--t2)">&#9660;</span>
    </div><div class="flt-b${i>0?' hide':''}" id="fBody${i}">
      <div class="pr"><label>Type</label><select id="fType${i}" onchange="updFltUI(${i});sched()">
        ${FTYPES.map((t,j)=>`<option value="${t}">${FLABELS[j]}</option>`).join('')}
      </select></div>
      <div class="pr"><label id="fL1_${i}">${FPARAM1[0]}</label><input type="number" id="fP1_${i}" value="${FDEF1[0]}" min="0.001" step="1"></div>
      <div class="pr"><label id="fL2_${i}">${FPARAM2[0]}</label><input type="number" id="fP2_${i}" value="${FDEF2[0]}" min="0.001" step="0.1"></div>
    </div></div>`;
  }
  $('filtersBody').innerHTML=h;
}
function tFlt(i){const b=$('fBody'+i);b.classList.toggle('hide');}

function buildInputFn(){
  const type=$('simSigType').value,amp=+$('simSigAmp').value,off=+$('simSigOff').value;
  const freq=Math.max(+$('simSigFreq').value||1,1e-6),td=+$('simSigDelay').value,duty=(+$('simSigDuty').value||50)/100;
  switch(type){
    case'step':return t=>off+(t>=td?amp:0);
    case'ramp':return t=>off+(t>=td?amp*(t-td):0);
    case'sine':return t=>off+amp*Math.sin(2*Math.PI*freq*t);
    case'square':return t=>off+amp*(((freq*t)%1+1)%1<duty?1:-1);
    case'sawtooth':return t=>off+amp*(2*(((freq*t)%1+1)%1)-1);
    default:return()=>off;
  }
}
function parseX0(){
  const s=$('simX0').value.trim();
  if(!s||s==='0')return[];
  return s.split(',').map(v=>+v.trim()).filter(v=>isFinite(v));
}
function updLoopMode(){
  const cl=$('simLoopMode').value==='cl';
  const pidEl=$('pidTgl');
  // Sync PID toggle with loop mode
  if(cl&&!pidEl.classList.contains('on'))pidEl.classList.add('on');
  if(!cl&&pidEl.classList.contains('on'))pidEl.classList.remove('on');
  updSimUI();
}
function updSimUI(){
  const t=$('simSigType').value;
  const cl=$('simLoopMode').value==='cl';
  const hasFreq=t==='sine'||t==='square'||t==='sawtooth';
  $('rowSigFreq').style.display=hasFreq?'flex':'none';
  $('rowSigDelay').style.display=!hasFreq?'flex':'none';
  $('rowSigDuty').style.display=t==='square'?'flex':'none';
  $('lblSigType').textContent=cl?'Reference':'Force';
  const isMSD=$('plantModel').value==='msd';
  if(t==='ramp')$('lblSigAmp').textContent=cl?(isMSD?'Slope (m/s)':'Slope (/s)'):(isMSD?'Slope (N/s)':'Slope (/s)');
  else $('lblSigAmp').textContent=cl?(isMSD?'Position (m)':'Amplitude'):(isMSD?'Force (N)':'Amplitude');
}
function updFltUI(i){
  const idx=FTYPES.indexOf($('fType'+i).value);
  $('fL1_'+i).innerHTML=FPARAM1[idx];
  $('fL2_'+i).innerHTML=FPARAM2[idx];
  $('fP1_'+i).value=FDEF1[idx];
  $('fP2_'+i).value=FDEF2[idx];
}

/* ========== 3D MSD VISUALIZATION ========== */
let scene3D,cam3D,ren3D,mass3D,spring3D,dpCyl3D,dpRod3D;
let msd3Dt=null,msd3Dy=null,msd3Du=null,msd3DForce=null,msd3DScale=1,msd3DElapsed=0,msd3DLastTs=null,msd3DPaused=false,msd3DReq=null,msd3DSpd=1,msd3DTend=10;
const WALL_X=-4,EQ_X=0,SP_Y=0.8,DP_Y=-0.1;
let orb={drag:false,px:0,py:0,th:0,ph:0.28,r:9.5};

function orbCam(){
  cam3D.position.set(-0.5+orb.r*Math.sin(orb.th)*Math.cos(orb.ph),orb.r*Math.sin(orb.ph),orb.r*Math.cos(orb.th)*Math.cos(orb.ph));
  cam3D.lookAt(-0.5,0.3,0);
}

function init3D(){
  if(ren3D)return;
  const el=$('w3DScene');
  scene3D=new THREE.Scene();
  scene3D.background=new THREE.Color(0x09090b);
  cam3D=new THREE.PerspectiveCamera(38,el.clientWidth/Math.max(el.clientHeight,1),0.1,100);
  orbCam();
  ren3D=new THREE.WebGLRenderer({antialias:true});
  ren3D.setPixelRatio(window.devicePixelRatio);
  ren3D.setSize(el.clientWidth,el.clientHeight);
  el.insertBefore(ren3D.domElement,el.firstChild);

  // Mouse orbit controls
  const cv=ren3D.domElement;
  cv.addEventListener('mousedown',e=>{orb.drag=true;orb.px=e.clientX;orb.py=e.clientY;});
  cv.addEventListener('mousemove',e=>{
    if(!orb.drag)return;
    orb.th-=(e.clientX-orb.px)*0.005;
    orb.ph=Math.max(0.05,Math.min(Math.PI/2.2,orb.ph+(e.clientY-orb.py)*0.005));
    orb.px=e.clientX;orb.py=e.clientY;
    orbCam();if(!msd3DReq)ren3D.render(scene3D,cam3D);
  });
  cv.addEventListener('mouseup',()=>{orb.drag=false;});
  cv.addEventListener('mouseleave',()=>{orb.drag=false;});
  cv.addEventListener('wheel',e=>{
    e.preventDefault();
    orb.r=Math.max(4,Math.min(20,orb.r+e.deltaY*0.01));
    orbCam();if(!msd3DReq)ren3D.render(scene3D,cam3D);
  },{passive:false});

  // Lighting
  scene3D.add(new THREE.AmbientLight(0x606060));
  const dl=new THREE.DirectionalLight(0xffffff,0.8);dl.position.set(4,8,6);scene3D.add(dl);
  const dl2=new THREE.DirectionalLight(0xffffff,0.3);dl2.position.set(-3,2,-4);scene3D.add(dl2);

  // Ground + grid
  const gnd=new THREE.Mesh(new THREE.PlaneGeometry(16,8),new THREE.MeshStandardMaterial({color:0x18181b}));
  gnd.rotation.x=-Math.PI/2;gnd.position.y=-0.61;scene3D.add(gnd);
  const grid=new THREE.GridHelper(14,14,0x3f3f46,0x27272a);grid.position.y=-0.6;scene3D.add(grid);

  // Wall (fixed)
  const wall=new THREE.Mesh(new THREE.BoxGeometry(0.3,3,2),new THREE.MeshStandardMaterial({color:0x52525b}));
  wall.position.set(WALL_X,0.9,0);scene3D.add(wall);
  // Hatching on wall back
  const hp=[];
  for(let i=0;i<8;i++){const y=-0.5+i*0.5;hp.push(WALL_X-0.16,y,1,WALL_X-0.16,y+0.3,-1);}
  const hg=new THREE.BufferGeometry();hg.setAttribute('position',new THREE.Float32BufferAttribute(hp,3));
  scene3D.add(new THREE.LineSegments(hg,new THREE.LineBasicMaterial({color:0x71717a})));

  // Mass block
  mass3D=new THREE.Mesh(new THREE.BoxGeometry(1.2,1.2,1.2),new THREE.MeshStandardMaterial({color:0xf59e0b,metalness:0.3,roughness:0.5}));
  mass3D.position.set(EQ_X,0.5,0);scene3D.add(mass3D);
  mass3D.add(new THREE.LineSegments(new THREE.EdgesGeometry(mass3D.geometry),new THREE.LineBasicMaterial({color:0xd97706})));

  // Helical spring
  spring3D=new THREE.Mesh(new THREE.BufferGeometry(),new THREE.MeshStandardMaterial({color:0x22c55e,metalness:0.4,roughness:0.4}));
  scene3D.add(spring3D);updSpring(EQ_X);

  // Damper body (cylinder housing)
  dpCyl3D=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.22,1.6,16,1,true),new THREE.MeshStandardMaterial({color:0x3b82f6,transparent:true,opacity:0.6,side:THREE.DoubleSide}));
  dpCyl3D.rotation.z=Math.PI/2;dpCyl3D.position.set(WALL_X+1.0,DP_Y,0);scene3D.add(dpCyl3D);
  const cap=new THREE.Mesh(new THREE.CircleGeometry(0.22,16),new THREE.MeshStandardMaterial({color:0x3b82f6,side:THREE.DoubleSide}));
  cap.rotation.y=Math.PI/2;cap.position.set(WALL_X+0.2,DP_Y,0);scene3D.add(cap);

  // Damper piston rod
  dpRod3D=new THREE.Mesh(new THREE.CylinderGeometry(0.07,0.07,3,8),new THREE.MeshStandardMaterial({color:0xa1a1aa,metalness:0.6,roughness:0.3}));
  dpRod3D.rotation.z=Math.PI/2;scene3D.add(dpRod3D);updDamper(EQ_X);

  // Force arrow
  const arrow=new THREE.ArrowHelper(new THREE.Vector3(1,0,0),new THREE.Vector3(EQ_X+1.2,0.5,0),1.2,0xef4444,0.3,0.15);
  arrow.name='forceArrow';scene3D.add(arrow);

  ren3D.render(scene3D,cam3D);
}

function helixCurve(x1,x2,cy,nCoils,radius){
  const len=x2-x1,lead=0.15;
  const pts=[];
  // Straight lead-in
  pts.push(new THREE.Vector3(x1,cy,0));
  const ax=x1+lead,bx=x2-lead,span=bx-ax;
  const segs=nCoils*32;
  for(let i=0;i<=segs;i++){
    const f=i/segs;
    pts.push(new THREE.Vector3(ax+f*span,cy+radius*Math.cos(f*nCoils*Math.PI*2),radius*Math.sin(f*nCoils*Math.PI*2)));
  }
  // Straight lead-out
  pts.push(new THREE.Vector3(x2,cy,0));
  return new THREE.CatmullRomCurve3(pts);
}
function updSpring(mx){
  spring3D.geometry.dispose();
  const curve=helixCurve(WALL_X+0.15,mx-0.6,SP_Y,8,0.18);
  spring3D.geometry=new THREE.TubeGeometry(curve,200,0.04,8,false);
}
function updDamper(mx){const s=WALL_X+0.2,len=Math.max(mx-0.6-s,0.2);dpRod3D.scale.y=len/3;dpRod3D.position.set(s+len/2,DP_Y,0);}
function setMassPos(mx){mass3D.position.x=mx;updSpring(mx);updDamper(mx);const a=scene3D.getObjectByName('forceArrow');if(a)a.position.x=mx+0.7;}

function upd3D(simD,loopLabel,forceD){
  const isMSD=$('plantModel').value==='msd';
  const msg=$('msd3DMsg'),ctrl=$('msd3DCtrl'),chartEl=$('w3DChart');
  if(!isMSD){
    if(msg)msg.classList.remove('hide');if(ctrl)ctrl.classList.add('hide');
    if(chartEl)chartEl.style.display='none';
    if(msd3DReq){cancelAnimationFrame(msd3DReq);msd3DReq=null;}
    if(ren3D){setMassPos(EQ_X);ren3D.render(scene3D,cam3D);}
    msd3Dt=null;return;
  }
  if(msg)msg.classList.add('hide');if(ctrl)ctrl.classList.remove('hide');
  if(chartEl)chartEl.style.display='';
  if(!ren3D)init3D();resize3D();
  msd3Dt=simD.t;msd3Dy=simD.y;msd3Du=simD.u;msd3DTend=simD.t[simD.t.length-1]||10;
  msd3DForce=forceD?forceD.y:null;
  const maxAbs=Math.max(...msd3Dy.map(Math.abs),1e-6);
  msd3DScale=Math.min(2.5/maxAbs,3);

  // 2D chart â€” labels depend on loop mode and plant
  const cl3D=$('simLoopMode').value==='cl';
  const msd3DPlant=$('plantModel').value==='msd';
  const inLabel=cl3D?(msd3DPlant?'Reference position (m)':'Reference r(t)'):(msd3DPlant?'Force (N)':'Input u(t)');
  const outLabel=cl3D?(msd3DPlant?'Position (m)':'Output y(t)'):(msd3DPlant?'Position (m)':'Output y(t)');
  const datasets=[
    {label:inLabel,data:simD.t.map((t,i)=>({x:t,y:simD.u[i]})),showLine:true,borderColor:'#3b82f6',borderWidth:1.5,borderDash:[6,3],pointRadius:0,order:3,yAxisID:'y'},
    {label:outLabel,data:simD.t.map((t,i)=>({x:t,y:simD.y[i]})),showLine:true,borderColor:COLS.main,borderWidth:2,pointRadius:0,order:2,yAxisID:'y'},
    {label:inLabel+' now',data:[{x:0,y:simD.u[0]}],pointRadius:5,pointBackgroundColor:'#3b82f6',pointBorderColor:'#3b82f6',showLine:false,order:-1,yAxisID:'y'},
    {label:outLabel+' now',data:[{x:0,y:simD.y[0]}],pointRadius:5,pointBackgroundColor:'#ef4444',pointBorderColor:'#ef4444',showLine:false,order:-1,yAxisID:'y'}
  ];
  // In closed-loop mode, add controller force trace
  if(cl3D&&forceD){
    const fLabel=msd3DPlant?'Controller force (N)':'Controller output u(t)';
    datasets.push({label:fLabel,data:simD.t.map((t,i)=>({x:t,y:forceD.y[i]})),showLine:true,borderColor:'#22c55e',borderWidth:1.5,borderDash:[4,2],pointRadius:0,order:1,yAxisID:'yF'});
    datasets.push({label:fLabel+' now',data:[{x:0,y:forceD.y[0]}],pointRadius:5,pointBackgroundColor:'#22c55e',pointBorderColor:'#22c55e',showLine:false,order:-1,yAxisID:'yF'});
  }
  const scales={
    x:{type:'linear',title:{display:true,text:'Time (s)',color:'#a1a1aa'},grid:{color:'#27272a'},ticks:{color:'#52525b'}},
    y:{type:'linear',position:'left',title:{display:true,text:cl3D?(msd3DPlant?'Position (m)':'Amplitude'):(msd3DPlant?'Force (N) / Position (m)':'Amplitude'),color:'#a1a1aa'},grid:{color:'#27272a'},ticks:{color:'#52525b'}}
  };
  if(cl3D&&forceD){
    scales.yF={type:'linear',position:'right',title:{display:true,text:msd3DPlant?'Force (N)':'Controller output',color:'#22c55e'},grid:{drawOnChartArea:false},ticks:{color:'#22c55e'}};
  }
  mkChart('c3DPos',{
    type:'scatter',
    data:{datasets},
    options:{
      responsive:true,maintainAspectRatio:false,animation:{duration:0},
      plugins:{
        title:{display:true,text:(loopLabel||'Open Loop')+' Response',color:'#e4e4e7',font:{size:13}},
        legend:{display:true,labels:{color:'#a1a1aa',font:{size:10},boxWidth:12,padding:6},position:'top'}
      },
      scales
    }
  });
  $('posMarker').style.display='block';

  msd3DElapsed=0;msd3DLastTs=null;msd3DPaused=false;
  $('msd3DPlayBtn').textContent='\u23f8';
  if(!msd3DReq)msd3DReq=requestAnimationFrame(anim3D);
}

function anim3D(ts){
  msd3DReq=null;
  if(!msd3Dt||curTab!=='3d')return;
  if(!msd3DPaused){if(msd3DLastTs!==null)msd3DElapsed+=(ts-msd3DLastTs)/1000*msd3DSpd;msd3DLastTs=ts;}
  const t=msd3DElapsed%msd3DTend;
  const fi=t/msd3DTend*(msd3Dt.length-1);
  const i0=Math.min(Math.floor(fi),msd3Dt.length-2),a=fi-i0;
  const y=msd3Dy[i0]*(1-a)+msd3Dy[Math.min(i0+1,msd3Dy.length-1)]*a;
  setMassPos(EQ_X+y*msd3DScale);
  // Scale 3D force arrow to actual force (controller output in CL, input in OL)
  const fSrc=msd3DForce||msd3Du;
  if(fSrc&&scene3D){
    const fv=fSrc[i0]*(1-a)+fSrc[Math.min(i0+1,fSrc.length-1)]*a;
    const arr=scene3D.getObjectByName('forceArrow');
    if(arr){const len=Math.max(Math.abs(fv)*0.8,0.15);arr.setLength(len,Math.min(0.3,len*0.3),0.15);arr.setDirection(new THREE.Vector3(fv>=0?1:-1,0,0));}
  }
  const te=$('msd3DTime');if(te)te.textContent=t.toFixed(2)+'s / '+msd3DTend.toFixed(1)+'s';
  const bar=$('msd3DBar');if(bar)bar.style.width=(t/msd3DTend*100)+'%';
  // Update 2D chart markers
  const ch=CS['c3DPos'];
  if(ch){
    const u=msd3Du?msd3Du[i0]*(1-a)+msd3Du[Math.min(i0+1,msd3Du.length-1)]*a:0;
    ch.data.datasets[2].data=[{x:t,y:u}];
    ch.data.datasets[3].data=[{x:t,y:y}];
    // Update force marker if present (datasets[4]=trace, [5]=marker in CL mode)
    if(msd3DForce&&ch.data.datasets.length>5){
      const f=msd3DForce[i0]*(1-a)+msd3DForce[Math.min(i0+1,msd3DForce.length-1)]*a;
      ch.data.datasets[5].data=[{x:t,y:f}];
    }
    ch.update('none');
    const mk=$('posMarker'),sx=ch.scales.x;
    if(mk&&sx){const px=sx.getPixelForValue(t);mk.style.left=px+'px';}
  }
  ren3D.render(scene3D,cam3D);
  msd3DReq=requestAnimationFrame(anim3D);
}

function resize3D(){if(!ren3D)return;const el=$('w3DScene'),w=el.clientWidth,h=el.clientHeight;if(w<1||h<1)return;cam3D.aspect=w/h;cam3D.updateProjectionMatrix();ren3D.setSize(w,h);if(CS['c3DPos'])CS['c3DPos'].resize();}
function msd3DToggle(){msd3DPaused=!msd3DPaused;$('msd3DPlayBtn').textContent=msd3DPaused?'\u25b6':'\u23f8';if(!msd3DPaused){msd3DLastTs=null;if(!msd3DReq)msd3DReq=requestAnimationFrame(anim3D);}}
function msd3DRestart(){msd3DElapsed=0;msd3DLastTs=null;msd3DPaused=false;$('msd3DPlayBtn').textContent='\u23f8';if(!msd3DReq)msd3DReq=requestAnimationFrame(anim3D);}
window.addEventListener('resize',()=>{setTimeout(resize3D,100);});

// Attach input listeners
function attachListeners(){
  document.querySelectorAll('.sidebar input[type=number],.sidebar input[type=text],.sidebar select').forEach(el=>{
    el.addEventListener('input',sched);
  });
}

// PWA service worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

// Init
updPlantUI();
updSimUI();
buildFilters();
attachListeners();
update();
</script>
</body>
</html>
